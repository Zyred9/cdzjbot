<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="layout/base :: layout(~{::body})">
<body>
<h2>合作方报备数据</h2>
<style>
    .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .input { padding: 8px 10px; border: 1px solid #dcdfe6; border-radius: 6px; outline: none; }
    .btn { padding: 8px 14px; border-radius: 6px; background: #1677ff; color: #fff; border: none; }
    .btn:hover { background: #0f66dd; }
    table { border-collapse: collapse; width: 100%; background: #fff; border-radius: 10px; overflow: hidden; }
    thead th { background: #f6f8fa; color: #333; padding: 10px 8px; border: 1px solid #e5e7eb; text-align: center; }
    tbody td { padding: 10px 8px; border: 1px solid #e5e7eb; text-align: center; }
    tbody tr:nth-child(odd) { background: #fcfcfd; }
    tbody tr:hover { background: #f2f8ff; }
    .pager { margin-top: 12px; }
</style>

<div class="toolbar">
    <input class="input" id="q_userId" placeholder="用户ID"/>
    <input class="input" id="q_username" placeholder="用户名"/>
    <input class="input" id="q_nickname" placeholder="用户昵称"/>
    <input class="input" id="q_address" placeholder="地址"/>
    <button class="btn" onclick="loadData(1)">查询</button>
    <button class="btn" onclick="refreshPage()">刷新</button>
    <button class="btn" th:onclick="|location.href='@{/pc/team(userId=${userId})}'|">去车队报备</button>
    <button class="btn" th:onclick="|location.href='@{/pc/acceptance(userId=${userId})}'|">去承兑报备</button>
</div>

<table>
    <thead>
    <tr>
        <th>主键ID</th>
        <th>用户ID</th>
        <th>用户名</th>
        <th>用户昵称</th>
        <th>地址</th>
        <th>模式</th>
        <th>钱包在现场</th>
        <th>补充要求</th>
        <th>操作</th>
    </tr>

    </thead>
    <tbody id="tbody"></tbody>
</table>

<div class="pager">
    <button class="btn" onclick="prev()">上一页</button>
    <span id="pageInfo"></span>
    <button class="btn" onclick="next()">下一页</button>
</div>

<script>
    let pageNo = 1, pageSize = 10, total = 0, pages = 0;

    function q(v){ const el = document.getElementById(v); return el ? el.value.trim() : ''; }
    function yesNo(v){ return v === true ? '是' : (v === false ? '否' : ''); }

    function refreshPage(){ loadData(pageNo); }

    function buildParams(pn){
        const p = new URLSearchParams();
        p.set('pageNo', pn.toString());
        p.set('pageSize', pageSize.toString());
        if(q('q_userId')) p.set('userId', q('q_userId'));
        if(q('q_username')) p.set('username', q('q_username'));
        if(q('q_nickname')) p.set('nickname', q('q_nickname'));
        if(q('q_address')) p.set('address', q('q_address'));
        return p.toString();
    }

    async function loadData(pn){
        const resp = await fetch('/api/partner/list?' + buildParams(pn));
        const data = await resp.json();
        pageNo = data.current || 1;
        pageSize = data.size || 10;
        total = data.total || 0;
        pages = data.pages || 0;

        const list = data.records || [];
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = list.map(it => `
            <tr>
                <td>${it.id ?? ''}</td>
                <td>${it.userId ?? ''}</td>
                <td>${it.username ?? ''}</td>
                <td>${it.nickname ?? ''}</td>
                <td>${it.address ?? ''}</td>
                <td>${it.models ?? ''}</td>
                <td>${yesNo(it.packet)}</td>
                <td>${it.supplement ?? ''}</td>
                <td>
                    <button class="btn" onclick="editRow(${it.id})">编辑</button>
                    <button class="btn" style="background:#ff4d4f" onclick="deleteRow(${it.id})">删除</button>
                </td>
            </tr>
        `).join('');

        document.getElementById('pageInfo').innerText = `第 ${pageNo} / ${pages} 页，共 ${total} 条`;
    }

    function prev(){ if(pageNo > 1) loadData(pageNo - 1); }
    function next(){ if(pageNo < pages) loadData(pageNo + 1); }

    // ======= 可视化编辑弹窗逻辑 =======
    let editCache = null;

    function openEditModal() { document.getElementById('editMask').style.display = 'block'; }
    function closeEditModal() { document.getElementById('editMask').style.display = 'none'; editCache = null; }

    async function editRow(id){
        const resp = await fetch('/api/partner/' + id);
        const item = await resp.json();
        editCache = item;

        setVal('e_username', item.username || '');
        setVal('e_nickname', item.nickname || '');
        setVal('e_address', item.address || '');
        setVal('e_model', item.model || '');
        setChecked('e_packet', !!item.packet);
        setVal('e_supplement', item.supplement || '');

        openEditModal();
    }
    function setVal(id, v){ const el = document.getElementById(id); if(el) el.value = v; }
    function setChecked(id, v){ const el = document.getElementById(id); if(el) el.checked = v; }

    async function saveEdit(){
        if(!editCache) return;
        const body = { ...editCache };
        body.username = document.getElementById('e_username').value.trim();
        body.nickname = document.getElementById('e_nickname').value.trim();
        body.address = document.getElementById('e_address').value.trim();
        body.model = document.getElementById('e_model').value.trim();
        body.packet = document.getElementById('e_packet').checked;
        body.supplement = document.getElementById('e_supplement').value.trim();

        const putResp = await fetch('/api/partner/' + body.id, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
        });
        const ok = await putResp.json();
        if(ok){ alert('更新成功'); closeEditModal(); refreshPage(); } else { alert('更新失败'); }
    }

    async function deleteRow(id){
        if(!confirm('确认删除该记录？')) return;
        const resp = await fetch('/api/partner/' + id, { method: 'DELETE' });
        const ok = await resp.json();
        if(ok){ alert('删除成功'); refreshPage(); } else { alert('删除失败'); }
    }

    loadData(1);
</script>

<!-- 编辑弹窗 -->
<style>
    .mask { display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 999; }
    .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 720px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .modal-hd { padding: 12px 16px; background: #f6f8fa; font-weight: 600; }
    .modal-bd { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-ft { padding: 12px 16px; text-align: right; background: #fafafa; }
    .form-item { display: flex; flex-direction: column; gap: 6px; }
    .label { color: #666; font-size: 13px; }
    .ipt, .txt { width: 100%; padding: 8px 10px; border: 1px solid #dcdfe6; border-radius: 6px; outline: none; }
</style>
<div id="editMask" class="mask">
    <div class="modal">
        <div class="modal-hd">编辑合作方报备</div>
        <div class="modal-bd">
            <div class="form-item"><span class="label">用户名</span><input id="e_username" class="ipt" placeholder="用户名"/></div>
            <div class="form-item"><span class="label">用户昵称</span><input id="e_nickname" class="ipt" placeholder="用户昵称"/></div>
            <div class="form-item"><span class="label">地址</span><input id="e_address" class="ipt" placeholder="地址"/></div>
            <div class="form-item"><span class="label">模式</span><input id="e_model" class="ipt" placeholder="模式"/></div>
            <div class="form-item"><label class="label"><input id="e_packet" type="checkbox"/> 钱包在现场</label></div>
            <div class="form-item" style="grid-column: span 2;"><span class="label">补充要求</span><input id="e_supplement" class="ipt" placeholder="补充要求"/></div>
        </div>
        <div class="modal-ft">
            <button class="btn" onclick="saveEdit()">保存</button>
            <button class="btn" style="background:#999" onclick="closeEditModal()">取消</button>
        </div>
    </div>
</div>

</body>
</html>